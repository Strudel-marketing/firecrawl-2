name: firecrawl
x-common-service: &common-service
  build: apps/api
  ulimits:
    nofile:
      soft: 65535
      hard: 65535
  networks:
    - backend
    - coolify
  extra_hosts:
    - 'host.docker.internal:host-gateway'
x-common-env: &common-env
  REDIS_URL: '${REDIS_URL}'
  REDIS_RATE_LIMIT_URL: '${REDIS_RATE_LIMIT_URL}'
  PLAYWRIGHT_MICROSERVICE_URL: '${PLAYWRIGHT_MICROSERVICE_URL}'
  NUQ_DATABASE_URL: '${NUQ_DATABASE_URL}'
  USE_DB_AUTHENTICATION: '${USE_DB_AUTHENTICATION}'
  OPENAI_API_KEY: '${OPENAI_API_KEY}'
  OPENAI_BASE_URL: '${OPENAI_BASE_URL}'
  MODEL_NAME: '${MODEL_NAME}'
  MODEL_EMBEDDING_NAME: '${MODEL_EMBEDDING_NAME}'
  OLLAMA_BASE_URL: '${OLLAMA_BASE_URL}'
  SLACK_WEBHOOK_URL: '${SLACK_WEBHOOK_URL}'
  BULL_AUTH_KEY: '${BULL_AUTH_KEY}'
  TEST_API_KEY: '${TEST_API_KEY}'
  POSTHOG_API_KEY: '${POSTHOG_API_KEY}'
  POSTHOG_HOST: '${POSTHOG_HOST}'
  SUPABASE_ANON_TOKEN: '${SUPABASE_ANON_TOKEN}'
  SUPABASE_URL: '${SUPABASE_URL}'
  SUPABASE_SERVICE_TOKEN: '${SUPABASE_SERVICE_TOKEN}'
  SELF_HOSTED_WEBHOOK_URL: '${SELF_HOSTED_WEBHOOK_URL}'
  LOGGING_LEVEL: '${LOGGING_LEVEL}'
  PROXY_SERVER: '${PROXY_SERVER}'
  PROXY_USERNAME: '${PROXY_USERNAME}'
  PROXY_PASSWORD: '${PROXY_PASSWORD}'
  SEARXNG_ENDPOINT: '${SEARXNG_ENDPOINT}'
  SEARXNG_ENGINES: '${SEARXNG_ENGINES}'
  SEARXNG_CATEGORIES: '${SEARXNG_CATEGORIES}'
services:
  api:
    <<: *common-service
    container_name: firecrawl-api
    environment:
      <<: *common-env
      HOST: '${HOST}'
      PORT: '${PORT}'
      WORKER_PORT: '${WORKER_PORT}'
      ENV: '${ENV}'
    depends_on:
      - firecrawl-redis
      - firecrawl-playwright
      - firecrawl-postgres
      - firecrawl-searxng
    ports:
      - '${PORT}:${PORT}'
    labels:
  - traefik.enable=true
  - traefik.docker.network=coolify
  - 'traefik.http.routers.firecrawl.rule=Host(`firecrawl.strudel.marketing`)'
  - traefik.http.routers.firecrawl.entrypoints=https
  - traefik.http.routers.firecrawl.tls.certresolver=letsencrypt
  - traefik.http.routers.firecrawl.service=firecrawl-service
  - traefik.http.services.firecrawl-service.loadbalancer.server.port=3002
    command: 'node dist/src/harness.js --start-docker'
  firecrawl-redis:
    image: 'redis:alpine'
    container_name: firecrawl-redis
    networks:
      - backend
    command:
      - redis-server
      - '--bind'
      - 0.0.0.0
      - '--requirepass'
      - '${REDIS_PASSWORD}'
    environment:
      REDIS_PASSWORD: '${REDIS_PASSWORD}'
  firecrawl-postgres:
    build: apps/nuq-postgres
    container_name: firecrawl-postgres
    environment:
      POSTGRES_USER: '${POSTGRES_USER}'
      POSTGRES_PASSWORD: '${POSTGRES_PASSWORD}'
      POSTGRES_DB: '${POSTGRES_DB}'
    networks:
      - backend
    command:
      - postgres
      - '-c'
      - 'listen_addresses=*'
  firecrawl-playwright:
    build: apps/playwright-service-ts
    container_name: firecrawl-playwright
    environment:
      PORT: '${PLAYWRIGHT_PORT}'
      PROXY_SERVER: '${PROXY_SERVER}'
      PROXY_USERNAME: '${PROXY_USERNAME}'
      PROXY_PASSWORD: '${PROXY_PASSWORD}'
      BLOCK_MEDIA: '${BLOCK_MEDIA}'
    networks:
      - backend
  firecrawl-searxng:
    image: searxng/searxng:latest
    container_name: firecrawl-searxng
    environment:
      - SEARXNG_BASE_URL=${SEARXNG_BASE_URL}
    volumes:
      - ./searxng:/etc/searxng:rw
    networks:
      - backend
    restart: unless-stopped
  firecrawl-mcp:
    image: node:22-alpine
    container_name: firecrawl-mcp
    command: sh -c "npm install -g firecrawl-mcp && npx -y firecrawl-mcp"
    environment:
      FIRECRAWL_API_KEY: '${FIRECRAWL_API_KEY:-selfhosted-demo-key}'
      FIRECRAWL_API_URL: 'http://api:3002'
      HTTP_STREAMABLE_SERVER: 'true'
      HOST: '0.0.0.0'
    depends_on:
      - api
    networks:
      - backend
      - coolify
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.docker.network=coolify
      - 'traefik.http.routers.firecrawl-mcp.rule=Host(`mcp.firecrawl.strudel.marketing`)'
      - traefik.http.routers.firecrawl-mcp.entrypoints=https
      - traefik.http.routers.firecrawl-mcp.tls.certresolver=letsencrypt
      - traefik.http.routers.firecrawl-mcp.service=firecrawl-mcp-service
      - traefik.http.services.firecrawl-mcp-service.loadbalancer.server.port=3002
networks:
  backend:
    driver: bridge
  coolify:
    external: true
